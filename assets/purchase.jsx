/** assets/purchase.jsx - ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö Base64 + ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡πá‡∏Ñ Spam */
const { useState, useEffect } = React;

// ‚≠ê ‡πÉ‡∏™‡πà Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwUGeIiAEu3JkIjCIsQ3WyoJMYA7PZ90vEDrDsOSi6Pc2MHd2VIwbwUFI8GuQtoqK5VeQ/exec";

// ----- ‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≠‡∏£‡πå‡∏° -----
function validatePurchaseForm(selectedPackage, values) {
  const e = {};
  if (!values.fullName || !values.fullName.trim()) e.fullName = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•";
  if (!values.email) e.email = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•";
  else if (!/^([^\s@]+)@([^\s@]+)\.[^\s@]+$/.test(values.email)) e.email = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
  if (!values.phone) e.phone = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£";
  if (selectedPackage === "IRT GOLD PC" && !values.mt5) e.mt5 = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏≠‡∏£‡πå‡∏ï MT5";
  if (!values.purchaseDate) e.purchaseDate = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠";
  if (!values.slip) e.slip = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô";
  return e;
}

// ----- ‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -----
const DEFAULTS = {
  heroUrl: "Github-p/bn/bn.png",
  pcImgUrl: "Github-p/irtpc/irtpc1.png",
  mbImgUrl: "Github-p/itrmb/mb1.png",
};

// ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(',')[1]; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà base64 string
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ----- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -----
function PurchaseForm({ selectedPackage, setSelectedPackage }) {
  const [form, setForm] = useState({
    fullName: "",
    email: "",
    phone: "",
    mt5: "",
    purchaseDate: "",
    slip: null,
  });
  const [errors, setErrors] = useState({});
  const [submitting, setSubmitting] = useState(false);
  const [success, setSuccess] = useState(null);

  async function handleSubmit(e) {
    e.preventDefault();

    const validation = validatePurchaseForm(selectedPackage, form);
    setErrors(validation);
    if (Object.keys(validation).length) {
      console.log('‚ùå Form validation failed:', validation);
      return;
    }

    setSubmitting(true);
    setSuccess(null);

    try {
      console.log('=== Starting form submission ===');
      console.log('üì¶ Package:', selectedPackage);
      console.log('üë§ Name:', form.fullName);
      console.log('üìß Email:', form.email);

      // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
      let slipBase64 = '';
      let slipName = '';
      let slipType = '';

      if (form.slip && form.slip instanceof File) {
        console.log('üìé Converting file to Base64...');
        console.log('   File name:', form.slip.name);
        console.log('   File size:', form.slip.size, 'bytes');
        console.log('   File type:', form.slip.type);

        slipBase64 = await fileToBase64(form.slip);
        slipName = form.slip.name;
        slipType = form.slip.type;

        console.log('‚úÖ Base64 conversion complete, length:', slipBase64.length);
      } else {
        console.error('‚ùå No valid file');
        throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
      }

      // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData ‡∏û‡∏£‡πâ‡∏≠‡∏° Base64
      const fd = new FormData();
      fd.append("selectedPackage", selectedPackage);
      fd.append("fullName", form.fullName);
      fd.append("email", form.email);
      fd.append("phone", form.phone);
      fd.append("mt5", selectedPackage === "IRT GOLD PC" ? form.mt5 : "");
      fd.append("purchaseDate", form.purchaseDate);
      fd.append("slipBase64", slipBase64);
      fd.append("slipName", slipName);
      fd.append("slipType", slipType);

      console.log('üì§ Sending to:', WEB_APP_URL);

      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        body: fd,
        redirect: 'follow'
      });

      console.log('üì• Response status:', res.status);
      console.log('üì• Response URL:', res.url);

      const contentType = res.headers.get("content-type");
      console.log('üì• Content-Type:', contentType);

      let data;
      if (contentType && contentType.includes("application/json")) {
        data = await res.json();
      } else {
        const text = await res.text();
        console.log('üì• Response text:', text.substring(0, 200));
        throw new Error('Response is not JSON');
      }

      console.log('üì• Response data:', data);

      if (!res.ok || !data.ok) {
        throw new Error(data.error || `HTTP ${res.status}`);
      }

      console.log('‚úÖ SUCCESS!');
      console.log('‚úÖ Slip URL:', data.slipUrl);

      setSuccess("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á");

      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
      setForm({
        fullName: "",
        email: "",
        phone: "",
        mt5: "",
        purchaseDate: "",
        slip: null
      });

      const fileInput = document.querySelector('input[type="file"]');
      if (fileInput) fileInput.value = '';

    } catch (err) {
      console.error('‚ùå Submit error:', err);
      setErrors({
        submit: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${String(err.message || err)}`
      });
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <div className="w-full bg-white rounded-2xl shadow-lg p-6 border-t-4 border-indigo-500">
      <h2 className="text-2xl font-semibold text-center mb-2 text-indigo-700">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</h2>
      <p className="text-center text-sm text-gray-500 mb-6">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      </p>

      {/* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div
          className={`cursor-pointer border rounded-xl p-4 transition-all duration-200 ${
            selectedPackage === "IRT GOLD PC"
              ? "border-indigo-500 bg-indigo-50 scale-[1.02]"
              : "border-gray-200 hover:border-indigo-300"
          }`}
          onClick={() => setSelectedPackage("IRT GOLD PC")}
        >
          <h3 className="font-bold text-indigo-700 flex items-center gap-2">
            <img src="Github-p/icon/Pc.png" alt="PC" className="h-5 w-5 object-contain" />
            IRT GOLD PC
          </h3>
          <p className="text-sm text-gray-600">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
          <p className="text-lg font-semibold text-indigo-600 mt-2">‡∏ø4,590</p>
        </div>

        <div
          className={`cursor-pointer border rounded-xl p-4 transition-all duration-200 ${
            selectedPackage === "IRT GOLD MB"
              ? "border-green-500 bg-green-50 scale-[1.02]"
              : "border-gray-200 hover:border-green-300"
          }`}
          onClick={() => setSelectedPackage("IRT GOLD MB")}
        >
          <h3 className="font-bold text-green-700 flex items-center gap-2">
            <img src="Github-p/icon/Mb.png" alt="Mobile" className="h-5 w-5 object-contain" />
            IRT GOLD MB
          </h3>
          <p className="text-sm text-gray-600">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</p>
          <p className="text-lg font-semibold text-green-600 mt-2">‡∏ø2,390</p>
        </div>
      </div>

      {/* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ */}
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input
            value={form.fullName}
            onChange={(e) => setForm({ ...form, fullName: e.target.value })}
            className={`mt-1 block w-full rounded-xl border px-3 py-2 ${
              errors.fullName ? "border-red-300" : "border-gray-200"
            }`}
            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®‡∏∏‡∏†‡∏ß‡∏±‡∏™‡∏™‡πå ‡πÄ‡∏•‡∏¥‡∏®‡∏ê‡∏≤‡∏ä‡∏±‡∏¢‡∏û‡∏£‡∏Å‡∏∏‡∏•"
          />
          {errors.fullName && <p className="text-xs text-red-600">{errors.fullName}</p>}
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input
            type="email"
            value={form.email}
            onChange={(e) => setForm({ ...form, email: e.target.value })}
            className={`mt-1 block w-full rounded-xl border px-3 py-2 ${
              errors.email ? "border-red-300" : "border-gray-200"
            }`}
            placeholder="you1234@gmail.com"
          />
          {errors.email && <p className="text-xs text-red-600">{errors.email}</p>}
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input
            value={form.phone}
            onChange={(e) => setForm({ ...form, phone: e.target.value })}
            className={`mt-1 block w-full rounded-xl border px-3 py-2 ${
              errors.phone ? "border-red-300" : "border-gray-200"
            }`}
            placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678"
          />
          {errors.phone && <p className="text-xs text-red-600">{errors.phone}</p>}
        </div>

        {selectedPackage === "IRT GOLD PC" && (
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏≠‡∏£‡πå‡∏ï MT5</label>
            <input
              value={form.mt5}
              onChange={(e) => setForm({ ...form, mt5: e.target.value })}
              className={`mt-1 block w-full rounded-xl border px-3 py-2 ${
                errors.mt5 ? "border-red-300" : "border-gray-200"
              }`}
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏≠‡∏£‡πå‡∏ï MT5 ‡πÄ‡∏ä‡πà‡∏ô 100400"
            />
            {errors.mt5 && <p className="text-xs text-red-600">{errors.mt5}</p>}
          </div>
        )}

        <div>
          <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input
            type="date"
            value={form.purchaseDate}
            onChange={(e) => setForm({ ...form, purchaseDate: e.target.value })}
            className={`mt-1 block w-full rounded-xl border px-3 py-2 ${
              errors.purchaseDate ? "border-red-300" : "border-gray-200"
            }`}
          />
          {errors.purchaseDate && <p className="text-xs text-red-600">{errors.purchaseDate}</p>}
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
          <input
            type="file"
            accept="image/*"
            onChange={(e) => {
              const file = e.target.files?.[0] ?? null;
              console.log('üìé File selected:', file ? file.name : 'none');
              if (file) {
                console.log('   Size:', file.size, 'bytes');
                console.log('   Type:', file.type);
              }
              setForm({ ...form, slip: file });
            }}
            className="mt-1 block w-full text-sm text-gray-700 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border file:border-gray-300 file:bg-indigo-50 hover:file:bg-indigo-100"
          />
          {errors.slip && <p className="text-xs text-red-600">{errors.slip}</p>}
        </div>

        {errors.submit && (
          <div className="rounded-lg bg-red-50 p-3 border border-red-200">
            <p className="text-sm text-red-700">{errors.submit}</p>
          </div>
        )}

        <button
          type="submit"
          disabled={submitting}
          className={`w-full rounded-xl py-3 font-semibold text-white shadow-md transition-all ${
            submitting
              ? "bg-indigo-300 cursor-wait"
              : "bg-gradient-to-r from-indigo-600 to-green-500 hover:scale-[1.02] hover:shadow-lg"
          }`}
        >
          {submitting ? "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." : "üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"}
        </button>
      </form>

      {/* ‚≠ê Success Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡πá‡∏Ñ Spam */}
      {success && (
        <div className="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
            <div className="text-6xl mb-4">‚úÖ</div>
            <h3 className="text-2xl font-bold text-green-700 mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p className="text-gray-700 mb-4">{success}</p>
            
            {/* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡πá‡∏Ñ Spam */}
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-left">
              <p className="text-sm text-gray-700 font-semibold mb-2">
                üìß ‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
              </p>
              <p className="text-xs text-gray-600 mb-2">
                ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà:
              </p>
              <ul className="text-xs text-gray-600 space-y-1">
                <li>üìÇ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Spam/‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏¢‡∏∞</li>
                <li>üìÇ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Promotions</li>
                <li>üìÇ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Updates</li>
              </ul>
              <p className="text-xs text-gray-500 mt-2 italic">
                üí° ‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß? ‡∏Å‡∏î "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡πÅ‡∏õ‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥
              </p>
            </div>
            
            <button
              onClick={() => setSuccess(null)}
              className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors"
            >
              ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// ----- ‡∏´‡∏ô‡πâ‡∏≤ Page -----
function Page({ initPackage }) {
  const [selectedPackage, setSelectedPackage] = useState(initPackage || "IRT GOLD PC");
  const [urls] = useState(DEFAULTS);

  useEffect(() => {
    const onSelect = (e) => e && e.detail && setSelectedPackage(e.detail);
    window.addEventListener("irt:select-package", onSelect);
    return () => window.removeEventListener("irt:select-package", onSelect);
  }, []);

  return (
    <div className="bg-white">
      <div className="w-full">
        <img src={urls.heroUrl} alt="IRT GOLD Banner" className="block w-full object-cover aspect-[21/8]" />
      </div>
      <div className="max-w-6xl mx-auto px-4 mt-8 mb-10">
        <PurchaseForm selectedPackage={selectedPackage} setSelectedPackage={setSelectedPackage} />
      </div>
    </div>
  );
}
window.Page = Page;
